# Interior Point Lab — руководство по сборке и тестированию

PWA-приложение в директории `projects/test_110/math-pwa` предназначено для
практики с методом внутренней точки для задач линейного программирования
(\(\min c^T x\) при ограничениях \(Ax = b,\; x > 0\)). Репозиторий содержит
как frontend на Vue 3, так и AssemblyScript-реализацию численного алгоритма,
собираемого в WebAssembly. Ниже приведено подробное описание архитектуры,
рабочих сценариев, а также инструкции по сборке, тестированию и запуску в
HTTPS-режиме для проверки PWA-функциональности.

## Возможности приложения

- **Решатель**: лог-барьерный метод внутренней точки с прямой/двойственной
  коррекцией, написанный на AssemblyScript и исполняемый в браузере через
  WebAssembly.
- **UI**: адаптивные формы ввода на Vue 3 + Tailwind CSS с валидацией,
  настройками точности, уведомлениями об ошибках и графиком динамики целевой
  функции.
- **PWA**: сервис-воркер, manifest и поддержка автообновления через
  `vite-plugin-pwa`.
- **Контейнеризация**: многоэтапный Dockerfile (Node → nginx) и manifest для
  Docker Swarm.
- **Base64-иконки**: исходники иконок хранятся в base64 и автоматически
  преобразуются в PNG при запуске npm-скриптов.

## Технологический стек

| Слой            | Технологии                                             |
|-----------------|---------------------------------------------------------|
| Web UI          | Vue 3 (Composition API), Vite, Tailwind CSS             |
| WASM            | AssemblyScript, `@assemblyscript/loader`                |
| PWA             | `vite-plugin-pwa`, автообновляемый сервис-воркер        |
| Инфраструктура  | Docker, nginx, Docker Swarm                             |
| Инструменты dev | TypeScript, Vitest, Vue TSC, npm                        |

## Структура репозитория

```
projects/test_110/
├── README.md                 # данный файл
└── math-pwa/
    ├── Dockerfile            # multi-stage: build → nginx
    ├── asconfig.json         # конфигурация AssemblyScript
    ├── docker-compose.yml    # стек для Docker Swarm
    ├── nginx.conf            # SPA-конфигурация nginx
    ├── package.json          # npm-скрипты и зависимости
    ├── public/
    │   ├── icons/*.base64    # источники иконок PWA
    │   └── manifest.json     # PWA manifest
    ├── scripts/decode-icons.mjs
    ├── src/
    │   ├── App.vue           # корневой layout и notifications
    │   ├── components/       # MathForm, ResultCard, GraphCanvas и т.д.
    │   ├── composables/      # useMathWasm, useMathTasks, useNotifications
    │   ├── styles/tailwind.css
    │   └── wasm/
    │       ├── assembly/index.ts  # метод внутренней точки
    │       └── tests/integration.spec.ts
    ├── tailwind.config.cjs
    ├── tsconfig*.json
    └── vite.config.ts
```

## Алгоритм внутренней точки

Основная экспортируемая функция AssemblyScript — `interiorPointSolve`. Она
принимает матрицу ограничений, векторы правых частей и стоимости, параметры
алгоритма и (опциональные) стартовые точки:

```ts
interiorPointSolve(
  A: Float64Array,  // матрица m × n в плоском построчном формате
  b: Float64Array,  // вектор длины m
  c: Float64Array,  // вектор длины n
  m: i32,           // число ограничений
  n: i32,           // число переменных
  maxIter: i32,     // максимум итераций
  tol: f64,         // порог по норме невязки
  x0: Float64Array, // необязательное начальное x
  s0: Float64Array  // необязательное начальное s
): Float64Array
```

Алгоритм реализует барьерный подход с вычислением системы Каруша—Куна—Таккера и
решением через матрицу Шура. Возвращаемый массив включает сводный статус,
значения метрик по итерациям и найденное решение. Фронтенд разбирает результат,
чтобы отобразить карточку решения и построить график.

## Подготовка окружения

1. **Установите зависимости Node.js** (рекомендован Node 20 LTS):
   ```bash
   cd projects/test_110/math-pwa
   npm install
   ```
2. **Сгенерируйте PNG-иконки** (обычно выполняется автоматически в скриптах,
   но при первом клоне можно вызвать вручную):
   ```bash
   npm run decode:icons
   ```
3. **Соберите WebAssembly** (создаёт optimized/untouched бинарники):
   ```bash
   npm run asbuild
   ```

## Локальная разработка

```bash
npm run dev
```

Скрипт выполнит декодирование иконок, пересоберёт WASM при необходимости и
запустит Vite на `http://localhost:5173`. Для работы на другом хосте/порту можно
использовать переменные окружения Vite (`VITE_PORT`, `VITE_HOST`).

### Тестирование и контроль качества

| Цель                                 | Команда                                        |
|-------------------------------------|------------------------------------------------|
| Юнит/интеграционные тесты (Vitest)  | `npm run test`                                 |
| Запуск конкретного файла тестов     | `npx vitest run src/wasm/tests/integration.spec.ts` |
| Проверка типов Vue/TS               | `npm run lint`                                 |
| Пересборка WASM с оптимизациями     | `npm run asbuild:optimized`                    |
| Пересборка WASM без оптимизаций     | `npm run asbuild:untouched`                    |

Vitest-тесты охватывают корректность вывода WASM-решателя и базовые случаи
валидации. Перед коммитом рекомендуется выполнить `npm run test && npm run lint`.

### Production-сборка и предпросмотр

```bash
npm run build       # собирает SPA + генерирует сервис-воркер
npm run preview     # локальный предпросмотр production-сборки
```

При каждом запуске `build`/`preview` автоматически вызывается `decode:icons`,
чтобы гарантировать наличие PNG-файлов, требуемых сервис-воркером и манифестом.

## Локальный HTTPS для тестирования PWA

Для полной проверки PWA (push, установка, offline) полезно запускать dev-сервер
по HTTPS. Конфигурация `vite.config.ts` поддерживает загрузку сертификатов из
переменных окружения:

1. **Сгенерируйте локальный сертификат** через [`mkcert`](https://github.com/FiloSottile/mkcert)
   (или аналогичный инструмент):
   ```bash
   mkcert -install                             # один раз на машине
   mkdir -p certs
   mkcert -cert-file certs/localhost.pem \
          -key-file certs/localhost-key.pem \
          "localhost" "127.0.0.1" "::1"
   ```

2. **Запустите Vite с указанием путей к сертификатам**:
   ```bash
   export VITE_HTTPS_CERT=certs/localhost.pem
   export VITE_HTTPS_KEY=certs/localhost-key.pem
   npm run dev
   ```

   Сервер будет доступен на `https://localhost:5173/`. Аналогично можно
   запускать `npm run preview`, чтобы проверить production-сборку в HTTPS.

3. **Обновление сертификатов**: при изменении ключей достаточно перезапустить
   Vite. Если переменные окружения не заданы или файлы не найдены, сервер
   остаётся в HTTP-режиме.

## PWA-функциональность

- В режиме разработки `vite-plugin-pwa` регистрирует сервис-воркер в devtools
  (`Application → Service Workers`). После первого посещения можно
  протестировать offline-режим (вкладка «Application → Service Workers → Offline»).
- Manifest хранится в `public/manifest.json`. Изображения берутся из `public/icons`
  и автоматически пересоздаются скриптом `decode-icons.mjs` из base64-версий.
- Для обновления иконок замените `.base64`-файлы и выполните `npm run decode:icons`.

## Контейнеризация и деплой

### Docker (локально)

```bash
docker build -t interior-point-pwa projects/test_110/math-pwa
docker run -p 8080:80 interior-point-pwa
```

Это запустит nginx, обслуживающий production-сборку из директории `dist`.
Конфигурация `nginx.conf` включает правило `try_files` для поддержки маршрутов SPA.

### Docker Swarm

```bash
cd projects/test_110/math-pwa
docker swarm init                # при необходимости
docker stack deploy -c docker-compose.yml ip-lab
```

Манифест разворачивает три реплики контейнера, включает стратегию обновления и
автоматический rollback при сбоях. После деплоя приложение доступно на
`http://<docker-host>:8080`.

## План дальнейшего развития

| Этап | Цели |
|------|------|
| 0. Подготовка (1 день) | Шаблоны задач, UX-исследования, дополнительные кейсы |
| 1. AssemblyScript (2 дня) | Предиктор-корректор, расширенная телеметрия, покрытие as-pect |
| 2. UI/UX (2–3 дня) | Табличная история итераций, улучшенная валидация, экспорт CSV |
| 3. PWA (1 день) | Настройка офлайн-кэша, добавление справочных страниц |
| 4. Docker & Swarm (1 день) | CI/CD, health-check, централизованное логирование |
| 5. Документация и QA (1 день) | Лайтхаус ≥ 90, e2e-smoke, шаблоны данных |

## Полезные советы

- Проверяйте корректность вводимых данных: матрица `A` должна иметь `m` строк и
  `n` столбцов, согласованных с длиной векторов `b` и `c`.
- Начальные значения `x0` и `s0` должны быть строго положительными. Если они не
  заданы, приложение использует единичные векторы.
- При больших задачах увеличивайте `maxIter` и ослабляйте `tol`, чтобы увидеть
  процесс сходимости.
- Для профилирования AssemblyScript-модуля можно подключить сборку
  `untouched.wasm` (без оптимизаций) и анализировать его через Chrome DevTools.

Следуя этому руководству, вы сможете собрать, протестировать и развернуть PWA, а
также включить HTTPS-режим для полноценного тестирования возможностей метода
внутренней точки в браузере.
