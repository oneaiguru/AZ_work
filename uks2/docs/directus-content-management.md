# Инструкция по управлению контентом в Directus

Документ описывает, как редактировать все разделы сайта УКС Иркутска через Directus 11, управлять медиатекой и подготавливать стартовый набор данных для новой базы. Руководство подходит редакторам контента, администраторам и техническим специалистам, обслуживающим стек `uks2/`.

## Содержание

1. [Доступ и роли](#1-доступ-и-роли)
2. [Медиатека и изображения](#2-медиатека-и-изображения)
3. [Домашняя страница](#3-домашняя-страница)
4. [Новости](#4-новости)
5. [Проекты](#5-проекты)
6. [Закупки](#6-закупки)
7. [Документы и реквизиты](#7-документы-и-реквизиты)
8. [Контакты и карта](#8-контакты-и-карта)
9. [Начальное заполнение базы](#9-начальное-заполнение-базы)
10. [Контроль качества и устранение неполадок](#10-контроль-качества-и-устранение-неполадок)

## 1. Доступ и роли

1. Откройте адрес из переменной `DIRECTUS_PUBLIC_URL` (боевой сервер — `https://uks.delightsoft.ru/admin`, локальная разработка — `http://uks2.localhost/admin`).
2. Авторизуйтесь с учётными данными администратора (`DIRECTUS_ADMIN_EMAIL` / `DIRECTUS_ADMIN_PASSWORD`).
3. Добавить новых сотрудников можно через **Настройки → Пользователи**. Доступные роли:
   - **admin** — полный доступ, изменение схемы и настроек;
   - **editor** — редактирование всех коллекций контента, без прав на системные параметры;
   - **manager_procurement** — доступ только к закупкам и документам;
   - **viewer** — просмотр без возможности правок.
4. Рекомендуется включать двухфакторную аутентификацию (2FA) для всех администраторов и редакторов.

## 2. Медиатека и изображения

1. Перейдите в раздел **Файлы** — это единое хранилище изображений и документов на бакете MinIO.
2. Нажмите **Загрузить** и выберите файлы или укажите публичный URL (Directus скачает изображение и создаст карточку).
3. Для каждого файла заполните метаданные: **Название**, **Описание**, **Alt-текст**. Они используются при формировании карточек и помогают SEO.
4. Чтобы добавить изображение в запись коллекции, нажмите в карточке файла **Копировать ID** и вставьте идентификатор в текстовое поле или JSON (например, в `homepage.hero_stats` можно хранить объект `{ "label": "лет", "value": "17", "image": "<file-id>" }` — фронтенд учитывает дополнительные ключи).
5. Публичная ссылка формируется как `${NEXT_PUBLIC_ASSETS_URL}/{file-id}`. Ссылку можно вставлять в Markdown/HTML или передать разработчикам для вывода баннеров.

## 3. Домашняя страница

Коллекция `homepage` — синглтон. Здесь настраиваются геро-блок, ценности, флагманский проект и статистика.

1. Откройте **Коллекции → homepage**. Запись одна — нажмите **Редактировать**.
2. Поля:
   - `hero_title` и `hero_subtitle` — заголовок и подзаголовок первой секции.
   - `hero_primary_label`/`hero_primary_href` и `hero_secondary_*` — кнопки CTA. Ссылки указываются относительные (`/zakupki`) или абсолютные.
   - `hero_stats` — массив объектов `{ "label": "лет", "value": "17" }`. Дополнительно можно хранить поле `image` с ID файла — фронтенд отобразит иконку рядом с показателем.
   - `about_intro` и `about_values` — описание компании и карточки ценностей. Каждая карточка — объект `{ "title": ..., "description": ... }`.
   - `flagship_title`, `flagship_description`, `flagship_highlights` — блок флагманского проекта. `flagship_highlights` — массив строк; можно добавить ключ `image` с ID файла для иконок.
3. После изменения нажмите **Сохранить** и проверьте главную страницу `https://uks.delightsoft.ru`.

## 4. Новости

Коллекция `news_articles` отвечает за раздел «Новости» на главной.

1. Откройте **Новости и анонсы → Создать**.
2. Заполните:
   - `title` — заголовок публикации;
   - `excerpt` — краткий текст (отображается на карточке);
   - `published_at` — дата/время публикации (используется для сортировки);
   - при необходимости `sort` — ручной приоритет (меньшее число поднимает запись).
3. Для баннера добавьте изображение в медиатеку и запишите ID в поле `image` (создайте доп.поле в карточке JSON, если используете кастомный интерфейс) либо вставьте ссылку `${NEXT_PUBLIC_ASSETS_URL}/{id}` в текст.
4. После сохранения запись появится в блоке «Анонсы и события». Проверьте формат даты и расположение.

## 5. Проекты

Коллекция `projects` содержит карточки реализованных объектов.

1. Нажмите **Проекты УКС → Создать**.
2. Поля:
   - `title` — название объекта (обязательно);
   - `slug` — латинское имя для URL (автоматически используется фронтендом для ссылки `/projects/<slug>`);
   - `category` — тип объекта (образование, спорт, городская среда и т. п.);
   - `year` — год завершения/начала проекта;
   - `description` — краткое описание (до 500–600 символов);
   - `sort` — числовой приоритет (0 по умолчанию).
3. Чтобы прикрепить изображения, загрузите файлы в медиатеку и добавьте их ID в JSON-поле `assets` (например, `["<file-id-1>", "<file-id-2>"]`). Разработчики могут использовать это поле для галерей.
4. Проверьте отображение на `/projects` и в карточке `/projects/<slug>`.

## 6. Закупки

Коллекция `procurements` управляет разделами «Актуальные процедуры», «Архив» и «План закупок».

1. Создайте запись с полями:
   - `title` — название процедуры;
   - `slug` — уникальный идентификатор для ссылок;
   - `status` — `draft`, `moderated`, `published` или `archived`;
   - `shortDescription` — описание карточки;
   - `procurementType` — тип закупки (`contract`, `commercial`, `service` и др.);
   - `startDate` / `endDate` — период подачи заявок (ISO-дату можно вставить из календаря);
   - `sort` — ручной приоритет.
2. Документы прикладывайте либо ссылкой в тексте, либо в коллекции `documents` (укажите URL на файл из медиатеки).
3. Проверяйте статусы — только `published` и `moderated` выводятся на главной странице.

## 7. Документы и реквизиты

1. Коллекция `documents` хранит регламенты, реквизиты, отчёты.
2. Поля:
   - `title` — название документа;
   - `category` — произвольная категория (используйте единые значения: «Закупки», «Учредительные документы», «Отчётность»);
   - `url` — ссылка на файл. Лучше копировать URL из медиатеки (`https://uks.delightsoft.ru/admin/assets/<id>` или локальный эквивалент), тогда файл остаётся под контролем Directus;
   - `documentDate` — дата публикации;
   - `sort` — порядок отображения.
3. Реквизиты и контактные данные вынесены отдельно в синглтоне `contacts` (см. раздел ниже).

## 8. Контакты и карта

Коллекция `contacts` — синглтон для раздела «Связаться с УКС».

- `address`, `phone`, `email`, `schedule` — текстовые поля для вывода на странице «Контакты».
- `lat` и `lng` — координаты для карты. Указывайте в десятичных градусах.
- Для загрузки схемы проезда или фотографий используйте медиатеку и добавьте ссылки в описание контактов.

## 9. Начальное заполнение базы

Для быстрого старта используется скрипт `uks2/scripts/seed-directus.js` и файл данных `uks2/scripts/seed-data.json`. Подробное руководство по импорту доступно в документе [«Импорт стартового контента в Directus»](directus-seed-import.md).

1. Настройте `.env` (`node scripts/generate-env.js --force`) и запустите инфраструктуру (`docker compose up -d`).
2. Выполните начальное заполнение:
   ```bash
   cd uks2
   node scripts/seed-directus.js --truncate
   ```
   Ключ `--truncate` очищает коллекции `projects`, `procurements`, `documents`, `news_articles` перед импортом, чтобы избежать дублей. Без ключа записи будут обновлены по `slug`/`title`.
   Если Node.js не установлен на хосте, тот же скрипт можно запустить из контейнера фронтенда:
   ```bash
   docker compose run --rm frontend node scripts/seed-directus.js --truncate
   ```
   Сидер автоматически ждёт, пока Directus ответит на `/server/health`. На холодном старте контейнеру Directus требуется до минуты, поэтому дождитесь сообщения `Waiting for Directus API to become available` и не прерывайте процесс.
3. Дополнительные параметры скрипта:
   - `--skip-images` — не скачивать изображения (актуально в окружениях без доступа к `uks.irkutsk.ru`);
   - `--dry-run` — показать операции без отправки запросов в Directus;
   - `--debug` — вывести подробный лог HTTP-запросов и шагов сидера;
   - `--data <путь>` — использовать альтернативный JSON-файл с данными;
   - `--max-images <N>` — ограничить количество импортируемых картинок.
   Поведение ожидания можно настроить переменными окружения `SEED_DIRECTUS_MAX_ATTEMPTS` (количество проверок здоровья, по умолчанию 12) и `SEED_DIRECTUS_RETRY_DELAY` (пауза между проверками в миллисекундах, по умолчанию 5000).
   Если Directus блокирует чтение системной коллекции ролей (ошибка `403` на `/roles/public`), задайте переменную `DIRECTUS_PUBLIC_ROLE_ID` с идентификатором публичной роли — сидер использует её для настройки прав без дополнительных запросов. В стандартной установке Directus ID публичной роли — `00000000-0000-0000-0000-000000000001`; это значение уже прописано в `.env.example`. Оно не связано с админским доступом: вход в интерфейс осуществляется учёткой `DIRECTUS_ADMIN_EMAIL` / `DIRECTUS_ADMIN_PASSWORD`.
4. Скрипт пытается скачать баннеры и фотографии с `https://uks.irkutsk.ru` (fallback-список лежит в `manualImages`). Если домен недоступен, запросы обрываются по таймауту с подсказкой использовать `--skip-images`, поэтому сидер больше не «зависает» на сетевых задержках.

## 10. Контроль качества и устранение неполадок

| Симптом | Проверка | Решение |
| --- | --- | --- |
| Новость/проект не отображается на сайте | Поля `status`, `published_at`, `sort` | Убедитесь, что статус `published`, дата публикации не в будущем, проверьте кеш фронтенда |
| Кнопки на главной ведут не туда | Поля `hero_primary_href` и `hero_secondary_href` | Указывайте относительные пути (`/zakupki`). После правки обновите страницу |
| Изображение не загружается | Лог в Directus, права доступа к бакету MinIO | Проверьте переменные `MINIO_*` и убедитесь, что файл не превышает лимит |
| Ошибка авторизации Directus | Лог `directus-1`, корректность пароля БД | Используйте `node scripts/generate-env.js --force --rotate-db-password` и инструкции из руководства по восстановлению |
| `seed-directus.js` завершился с `403` на `/roles/public` | Включён ли `DIRECTUS_PUBLIC_ROLE_ID` в `.env` | Узнайте идентификатор публичной роли в Directus и сохраните его в `DIRECTUS_PUBLIC_ROLE_ID`, после чего повторите запуск сидера |
| Нужно заполнить базу заново | Повторить `node scripts/seed-directus.js --truncate` или `docker compose run --rm frontend node scripts/seed-directus.js --truncate` | Перед перезапуском убедитесь, что Directus доступен и `.env` актуален |

Перед публикацией просматривайте страницы сайта на десктопе и мобильных устройствах, проверяйте корректность ссылок, метаданных файлов и наличие alt-текста у изображений.
