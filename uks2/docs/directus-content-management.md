# Инструкция по управлению контентом в Directus

Документ предназначен для редакторов и администраторов сайта УКС Иркутска, использующих Directus 11 в составе стека `uks2/`. Руководство описывает полный цикл работы с материалами: от входа в систему до проверки публикаций на сайте.

## 1. Доступ и роли

1. Откройте браузер и перейдите по адресу, указанному в переменной `DIRECTUS_PUBLIC_URL` (по умолчанию `https://cms.uks2.localhost/admin`).
2. Авторизуйтесь с помощью учётных данных администратора (`DIRECTUS_ADMIN_EMAIL` и `DIRECTUS_ADMIN_PASSWORD`).
3. Чтобы добавить новых сотрудников, перейдите в **Настройки → Пользователи**, создайте запись и назначьте роль:
   - **admin** — полный доступ ко всем настройкам и коллекциям;
   - **editor** — редактирование контента без изменения системных параметров;
   - **manager_procurement** — управление закупками и коммерческими помещениями;
   - **viewer** — просмотр без права редактирования.
4. При необходимости подключите двухфакторную аутентификацию (2FA) в профиле пользователя.

## 2. Медиатека

1. Перейдите в раздел **Файлы**.
2. Нажмите **Загрузить** и добавьте изображения или документы. Directus сохранит их в бакете MinIO, настроенном в разделе **Настройки → Хранилища**.
3. Для каждого файла заполните **Название**, **Описание** и **Alt-текст** — эти поля используются на сайте и влияют на SEO.
4. Создавайте папки для логической группировки (например, `news`, `projects`, `documents`).
5. При замене файла используйте действие **Новая версия**, чтобы сохранить историю изменений.

## 3. Публикация новостей и статей

1. Откройте коллекцию **news_articles**.
2. Нажмите **Создать элемент** и заполните поля:
   - **title** — заголовок публикации;
   - **slug** — адрес страницы латиницей (используется в URL `/news/<slug>`);
   - **excerpt** — краткое описание для превью;
   - **content** — основной текст (Markdown или WYSIWYG);
   - **cover** — выберите изображение из медиатеки;
   - **published_at** — дата публикации;
   - **status** — установите `published`, чтобы материал появился на сайте.
3. Прикрепите теги или связанные проекты, если требуется.
4. Сохраните запись. На фронтенде новость появится в разделе «Закупки» и на главной странице в блоке новостей согласно настройкам.

## 4. Проекты и галереи

1. Перейдите в **projects** и откройте существующий проект или создайте новый.
2. Заполните основные поля: **title**, **slug**, **year**, **type**, **status**, **summary**, **description**.
3. В блоке **gallery** добавьте элементы `project_gallery_item`: для каждого выберите изображение и подпись.
4. В разделе **documents** прикрепите связанные файлы (паспорта проектов, планы и т. д.).
5. Укажите координаты на карте, чтобы блок «Контакты» и интерактивные карты подгружали корректные данные.
6. Переключите статус проекта на `published` и сохраните изменения.

## 5. Закупки и коммерческие помещения

1. Откройте коллекцию **procurements**.
2. Заполните обязательные поля: **title**, **procurement_type**, **status**, **start_date**, **end_date**, **manager_name**, **manager_phone**, **manager_email**.
3. Добавьте краткое описание в **short_description** и развернутый текст в **full_description**.
4. В поле **documents** загрузите или выберите файлы (тендерная документация, проекты договоров). Размер файла ограничен значением `DIRECTUS_FILE_LIMIT`.
5. Поле **eis_links** поддерживает несколько URL — добавляйте каждую ссылку с новой строки.
6. Используйте статусы:
   - `draft` — черновик, виден только редакторам;
   - `review` — отправлено на проверку редактору/администратору;
   - `published` — отображается на сайте в реестре активных закупок;
   - `archived` — переносится в архив.
7. Для коммерческих помещений установите соответствующий тип (`commercial`) и заполните площадь, стоимость и актуальность в кастомных полях.

## 6. Документы и реквизиты

1. Коллекция **documents** содержит нормативные акты, договора и реквизиты.
2. Заполните поля: **title**, **document_type**, **issued_at**, **file**, **description**.
3. Включите переключатель **is_visible**, чтобы документ отображался на странице `/documents`.
4. Для реквизитов используйте коллекции **contacts** и **about_values** — они отвечают за блоки «Контакты» и «О компании».

## 7. Настройки главной страницы

1. В коллекции **homepage** хранится структура лендинга: геро-блок, счётчики, списки преимуществ, ссылки на документы и т. д.
2. Редактируйте текстовые блоки и изображения, сохраняйте изменения и проверяйте результат на сайте.
3. Для JSON-полей используйте режим «Редактор кода», чтобы избежать ошибок в структуре.

## 8. Проверка и публикация

1. После сохранения откройте сайт (`https://uks2.localhost` или боевой домен) и убедитесь, что изменения отображаются корректно.
2. Если правки не появились, очистите кеш Directus: **Настройки → Система → Очистить кеш**.
3. Для визуального контроля используйте кнопки **Просмотр** (если настроены Flows) или ссылку на внешний сайт.

## 9. Версионность и откат

1. Directus автоматически сохраняет ревизии. В карточке записи нажмите **История**, чтобы просмотреть предыдущие версии.
2. Выберите нужную ревизию и нажмите **Восстановить** для отката.
3. Для массовых изменений делайте снапшоты структуры: `npx directus schema snapshot snapshot.yaml --yes`.

## 10. Резервное копирование

- **База данных**: используйте `pg_dump` или встроенные бэкапы хостинга.
- **Файлы**: регулярно синхронизируйте бакеты MinIO командой `mc mirror`.
- **Настройки Directus**: храните `snapshot.yaml`, экспорт ролей и пользователей в системе контроля версий.

## 11. Устранение неполадок

| Симптом | Возможная причина | Решение |
| --- | --- | --- |
| Ошибка 400 на `/auth/login` или `/auth/refresh` | Домен в cookie не совпадает с адресной строкой | Проверьте `DIRECTUS_PUBLIC_URL` и `DIRECTUS_COOKIE_DOMAIN`; перезапустите Directus |
| Файлы не загружаются | Неверные учётные данные MinIO или превышен размер файла | Проверьте `MINIO_*` переменные в `.env`, обновите политики доступа |
| Запись не отображается на сайте | Статус `draft` или выключен флаг видимости | Переключите статус на `published`, убедитесь, что флаг `is_visible` включён |
| Ошибка доступа у редактора | Роль не имеет нужных прав | В **Настройки → Роли и разрешения** добавьте права на коллекцию |

## 12. Контроль качества перед публикацией

1. Проверьте корректность орфографии и форматирование текста в WYSIWYG/Markdown.
2. Убедитесь, что изображения оптимизированы (WebP, размер до 2 МБ) и заданы alt-тексты.
3. Сверьте контактные данные и сроки закупок с официальными документами.
4. Просмотрите страницу в мобильной и десктопной вёрстке (функции предварительного просмотра в браузере).

Следуя этому руководству, редакторы смогут оперативно обновлять материалы сайта и поддерживать их актуальность без привлечения разработчиков.
