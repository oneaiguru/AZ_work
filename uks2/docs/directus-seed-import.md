# Импорт стартового контента в Directus скриптом `seed-directus.js`

Это руководство описывает полный цикл импорта демонстрационных данных УКС Иркутска в Directus 11 с помощью Node.js-скрипта `uks2/scripts/seed-directus.js`. Документ предназначен для разработчиков, администраторов и инженеров сопровождения, которые подготавливают новое окружение или восстанавливают контент.

## 1. Что делает скрипт

Скрипт автоматизирует:

- ожидание готовности Directus (включая опрос нескольких URL-кандидатов и повторные попытки с настраиваемыми таймаутами);
- аутентификацию через администратора или статический токен;
- создание и обновление данных из `uks2/scripts/seed-data.json` (синглтоны, коллекции, связи);
- очистку коллекций перед импортом (опция `--truncate`);
- скачивание изображений с внешних источников и загрузку их в Directus (с ограничением на количество и возможностью пропуска);
- подробный вывод статуса шагов и диагностику ошибок, включая стек-трейсы и причины отказа сетевых запросов.

## 2. Предварительные требования

1. Node.js 18+ установлен локально (скрипт использует глобальный `fetch`).
2. Выполнен `npm install` в корне репозитория (для зависимостей вспомогательных скриптов).
3. В каталоге `uks2/` создан и актуален файл `.env` (сгенерируйте `node scripts/generate-env.js --force`).
4. Контейнеры инфраструктуры запущены (`docker compose up -d`). Для импорта достаточно сервисов `postgres`, `redis`, `minio`, `directus`, `directus-storage-permissions`.
5. Если запуск осуществляется вне Docker-сети, убедитесь, что выбранный URL Directus (например, `http://localhost/cms`) доступен с хоста.

## 3. Подготовка Directus

1. При первом запуске выполните `docker compose up directus-storage-permissions` (однократно), чтобы создать каталог `directus/uploads` с нужными правами.
2. Убедитесь, что Directus прошёл health-check: `curl -f http://localhost/cms/server/health` должен вернуть `200`. Скрипт сделает это автоматически, но ручная проверка позволяет быстрее обнаружить сетевые или TLS-проблемы.
3. Проверьте переменные окружения `DIRECTUS_ADMIN_EMAIL` / `DIRECTUS_ADMIN_PASSWORD` или подготовьте статический токен администратора.

## 4. Базовый сценарий запуска

```bash
cd uks2
node scripts/seed-directus.js --truncate
```

- `--truncate` очищает коллекции `projects`, `procurements`, `documents`, `news_articles` перед импортом, предотвращая дубли.
- После завершения скрипт выведет сводку по каждому шагу. При ошибке отображается текущий шаг и детальный стек.

### Запуск внутри контейнера Node

Если Node.js недоступен на хосте, используйте контейнер:

```bash
docker compose run --rm frontend node scripts/seed-directus.js --truncate
```

Сервис `frontend` уже содержит Node 18+ и доступ к исходникам через тома.

## 5. Конфигурация URL Directus

Скрипт формирует список URL-кандидатов из:

1. явных флагов `--directus-url` (можно передать несколько раз);
2. переменных окружения `DIRECTUS_SEED_URL`, `DIRECTUS_PUBLIC_URL`, `NEXT_PUBLIC_CMS_URL`, `CMS_INTERNAL_URL`, `DIRECTUS_INTERNAL_URL`;
3. дефолтов `http://localhost/cms` и `http://localhost:8055`.

Каждый адрес нормализуется и проверяется до тех пор, пока не ответит health-check `/server/health`. При ошибках DNS или сетевых таймаутах кандидат пропускается с пояснением причины.

### Настройка таймаутов ожидания

- `--wait-timeout <сек>` / `--wait-timeout-ms <мс>` — общее время ожидания готовности (по умолчанию 300 000 мс / 5 минут).
- `--wait-interval <сек>` / `--wait-interval-ms <мс>` — интервал между повторными запросами (по умолчанию 2 000 мс).

Эти параметры можно задать и через переменные `DIRECTUS_WAIT_TIMEOUT_MS`, `DIRECTUS_WAIT_INTERVAL_MS`.

## 6. Аутентификация

Скрипт поддерживает три сценария:

1. Авторизация по логину/паролю (`DIRECTUS_ADMIN_EMAIL` и `DIRECTUS_ADMIN_PASSWORD`).
2. Использование статического токена API (`DIRECTUS_ADMIN_STATIC_TOKEN`).
3. Передача токена через флаги `--token` или `--token-file`.

По умолчанию токен передаётся в заголовке `Authorization: Bearer …`. При необходимости можно указать транспорт `query` или `both` для отдельных запросов (опция `directusTokenTransport` в коде скрипта, используется для совместимости со старым API `/files/import`).

## 7. Работа с данными и изображениями

- Источник данных: `uks2/scripts/seed-data.json`. Можно заменить файлом из другого окружения через `--data ./my-seed.json`.
- Ограничение изображений: `--max-images <N>` (дефолт `12`). Полезно при локальной разработке.
- Пропуск загрузки изображений: `--skip-images` (оставляет только метаданные без файлов).
- `--dry-run` показывает план действий без отправки запросов в Directus.

Во время импорта скрипт логирует, откуда берётся каждое изображение, и сообщает о fallback-URL, если основной источник недоступен.

## 8. Типичные проблемы и их решения

| Симптом | Причина | Решение |
| --- | --- | --- |
| `fetch failed` при ожидании готовности | Неверный URL или Directus ещё не поднялся | Проверьте, что контейнер `directus` запущен, и передайте корректный `--directus-url` |
| `getaddrinfo EAI_AGAIN` | DNS не может разрешить хост | Используйте IP-адрес или локальный домен, доступный с машины запуска |
| `EACCES: permission denied, open '/directus/uploads/…'` | Неверные права на каталог загрузок | Выполните `docker compose up directus-storage-permissions` и перезапустите Directus |
| `403 Forbidden` при обновлении синглтонов | У аккаунта нет прав администратора | Создайте статический токен с ролью `admin` и передайте его через `--token` или переменные окружения |
| `Invalid payload. "title" is not allowed` при импорте файлов | Устаревший формат запроса | Убедитесь, что используется актуальная версия репозитория (в `withAuth` метаданные отправляются в поле `data`) |
| `Invalid payload. The request uses more than one method for including an access token.` | Токен передан и в заголовке, и в query-параметре | Не используйте ручное добавление `?access_token=...`, доверьте авторизацию скрипту |

## 9. Проверка результата

1. Откройте `https://uks.delightsoft.ru/cms/admin` (или локальный адрес) и проверьте, что коллекции заполнены.
2. На фронтенде убедитесь, что главная страница, проекты и новости отображаются корректно.
3. Просмотрите логи `directus` и `nginx`, чтобы исключить ошибки при отдаче медиафайлов.

## 10. Повторное использование

- Для обновления данных без очистки повторите запуск без `--truncate` — скрипт обновит существующие записи по ключевым полям (`slug`, `title`, `id`).
- Для миграции на новую площадку сохраните актуальный `seed-data.json`, перенесите его в новое окружение и запустите скрипт с теми же флагами.
- Используйте `--dry-run` перед внесением крупных правок в набор данных, чтобы убедиться в корректности конфигурации.

---

При возникновении новых сценариев обновляйте это руководство и дополняйте `seed-data.json` новыми коллекциями. Так команда сможет быстро разворачивать контент в любых средах.
