# Устранение ошибки аутентификации PostgreSQL

Сообщение вида:

```
postgres-1  | FATAL:  password authentication failed for user "uks2"
directus-1  | error: password authentication failed for user "uks2"
```

означает, что пароль пользователя базы данных в работающем экземпляре PostgreSQL не совпадает со значением `DATABASE_PASSWORD` в `uks2/.env`. Ниже приведены шаги, которые помогают безопасно синхронизировать пароль и вернуть сервисы в рабочее состояние.

## 1. Убедитесь, что контейнеры запущены

Пароль можно сменить только изнутри PostgreSQL. Если контейнеры остановлены, запустите хотя бы PostgreSQL:

```bash
docker compose up -d postgres
```

Команда должна выполняться из каталога `uks2/`, где расположен `docker-compose.yml`.

## 2. Сравните текущий пароль и значение в `.env`

Откройте `uks2/.env` и найдите параметры:

```ini
DATABASE_USERNAME=uks2
DATABASE_NAME=uks2
DATABASE_PASSWORD=<значение>
```

Если файл `.env` регенерировали недавно, пароль мог измениться. Чтобы убедиться, какой пароль записан в PostgreSQL, выполните подключение с использованием старого значения (если оно сохранилось) или попросите коллегу, у которого контейнер не перезапускался, подсказать актуальное значение. При наличии доступа к резервным копиям можно посмотреть пароль в архивном `.env`.

## 3. Выполните смену пароля через `ALTER USER`

Передайте актуальное (старое) значение пароля в переменную `PGPASSWORD`, чтобы `psql` смог подключиться к базе. Новое значение из `.env` нужно экранировать: замените одинарные кавычки на две подряд, иначе команда завершится ошибкой синтаксиса.

```bash
# замените <старый_пароль> на значение, которое сейчас записано в PostgreSQL
# новое значение возьмите из uks2/.env
SQL_PASSWORD=$(printf "%s" "$DATABASE_PASSWORD" | sed "s/'/''/g")
PGPASSWORD='<старый_пароль>' docker compose exec -T postgres \
  psql -U "$DATABASE_USERNAME" -d "$DATABASE_NAME" \
  -c "ALTER USER \"$DATABASE_USERNAME\" WITH PASSWORD '$SQL_PASSWORD'"
```

> ℹ️ При выполнении команды оболочка подставит значение `SQL_PASSWORD` уже с экранированными кавычками, поэтому можно безопасно использовать пароли с апострофами и пробелами.

Если не уверены в старом пароле, попробуйте несколько вариантов. При ошибке `psql: error: connection to server at "postgres" ... FATAL: password authentication failed` — указан неверный текущий пароль.

## 4. Перезапустите зависимые сервисы

После успешного `ALTER USER` перезапустите Directus и другие контейнеры, которые используют базу данных:

```bash
docker compose restart directus
docker compose restart frontend
```

Либо перезапустите всё приложение:

```bash
docker compose up -d
```

## 5. Проверьте логи

Убедитесь, что Directus больше не перезапускается с ошибкой аутентификации:

```bash
docker compose logs -f directus
```

Если логов об ошибке нет, можно открыть админку по адресу `https://uks.delightsoft.ru/admin` (или локальный путь `http://uks2.localhost/admin`).

## Что делать, если пароль неизвестен

Если выяснить старый пароль невозможно (например, `.env` утерян, а резервные копии отсутствуют), остаётся сбросить кластер и восстановить его из бэкапов контента Directus:

1. Остановите сервисы:
   ```bash
   docker compose down
   ```
2. Удалите том данных PostgreSQL:
   ```bash
   docker volume rm uks2_postgres-data
   ```
3. Снова поднимите стэк, чтобы база была создана с нуля:
   ```bash
   docker compose up -d
   ```
4. Восстановите данные из резервной копии Directus (`directus data import` или импорт snapshot).

Это крайняя мера, поэтому рекомендуется хранить актуальный `.env` и регулярно делать резервные копии.

## Сидер завершается с ошибкой 403 при доступе к коллекциям

Сообщения вида `Directus запретил чтение коллекции "projects"` означают, что токен аутентификации не имеет прав администратора либо схема коллекции не загружена.

1. Проверьте, что заданы `DIRECTUS_ADMIN_EMAIL` и `DIRECTUS_ADMIN_PASSWORD` от супер-админа Directus либо установите `DIRECTUS_ACCESS_TOKEN` со статическим токеном администратора.
2. Убедитесь, что на инстансе применён snapshot со схемой (`npx directus schema apply directus/snapshot.yaml`). Если коллекция отсутствует, API вернёт 404/403.
3. После обновления прав перезапустите `docker compose up -d` и выполните сидер повторно (`node scripts/seed-directus.js --truncate --debug`). В debug-логе будет видно, какой шаг блокирует доступ.
